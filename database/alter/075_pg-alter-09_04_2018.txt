set schema 'zafira';

DROP TABLE IF EXISTS VERSIONS;
CREATE TABLE VERSIONS (
  ID SERIAL,
  VERSION VARCHAR(255) NOT NULL,
  MODIFIED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (ID));
CREATE TRIGGER update_timestamp_versions BEFORE INSERT OR UPDATE ON VERSIONS
  FOR EACH ROW EXECUTE PROCEDURE update_timestamp();



CREATE OR REPLACE FUNCTION check_version(varchar) RETURNS VOID AS $$
    BEGIN
		IF EXISTS (SELECT ID FROM zafira.VERSIONS AV WHERE AV.VERSION = $1) THEN
			RAISE EXCEPTION 'Alter table can not be executed';
		END IF;
    END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION add_version(varchar) RETURNS VOID AS $$
    BEGIN
		INSERT INTO zafira.VERSIONS (VERSION) VALUES ($1);
    END;
$$ LANGUAGE plpgsql;

select add_version('074_pg-alter-09_03_2018');